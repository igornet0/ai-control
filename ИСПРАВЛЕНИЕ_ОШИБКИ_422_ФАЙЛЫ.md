# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò 422 –ù–ê –°–¢–†–ê–ù–ò–¶–ï "–§–ê–ô–õ–´"

## üö® **–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
```
Failed to load resource: the server responded with a status of 422 (Unprocessable Entity) (attachments, line 0)
Error fetching files: Error: [object Object] ‚Äî http.js:17
```

## üîç **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

### **–ò—Å—Ç–æ—á–Ω–∏–∫ –æ—à–∏–±–∫–∏:**
- ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞** `favorite_files` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚ùå API endpoint `/api/projects/attachments` –Ω–µ –º–æ–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ
- ‚ùå SQLAlchemy –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –æ—à–∏–±–∫—É –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ `FavoriteFile` –º–æ–¥–µ–ª–∏

### **–õ–æ–≥–∏ backend –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏:**
```bash
GET /api/projects/attachments?sort_by=name&sort_order=asc&limit=10 HTTP/1.1" 422 Unprocessable Entity
GET /api/projects/favorites/attachments?sort_by=name&sort_order=asc&limit=10 HTTP/1.1" 422 Unprocessable Entity
```

### **–ü—Ä–∏—á–∏–Ω–∞:**
–ö–æ–¥ –≤ `backend/api/routers/projects/router.py` –ø—ã—Ç–∞–ª—Å—è –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Ç–∞–±–ª–∏—Ü–µ `favorite_files`:
```python
from core.database.models.document_model import FavoriteFile
fav_query = select(FavoriteFile).where(FavoriteFile.user_id == current_user.id)
```

–ù–æ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## üõ†Ô∏è **–†–µ—à–µ–Ω–∏–µ:**

### **1. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic:**
–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `alembic/versions/2025_08_31_1415-add_favorite_files_table.py`:

```python
def upgrade() -> None:
    # Create favorite_files table
    op.create_table('favorite_files',
        sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
        sa.Column('user_id', sa.BigInteger(), nullable=False),
        sa.Column('project_id', sa.BigInteger(), nullable=False),
        sa.Column('filename', sa.String(length=255), nullable=False),
        sa.Column('added_at', sa.DateTime(), nullable=False, server_default=sa.text('now()')),
        sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('user_id', 'project_id', 'filename', name='uq_user_project_filename')
    )
    
    # Create indexes
    op.create_index('idx_favorite_files_user_id', 'favorite_files', ['user_id'])
    op.create_index('idx_favorite_files_project_filename', 'favorite_files', ['project_id', 'filename'])
```

### **2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
docker exec -it ai-control-backend-dev alembic upgrade head
```

### **3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend:**
```bash
docker-compose -f aic_docker/docker-compose.dev.yml restart backend
```

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
HTTP/1.1 422 Unprocessable Entity
```

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
HTTP/1.1 401 Unauthorized  # ‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
```

## üîß **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã:**

```sql
Table "public.favorite_files"
   Column   |            Type             | Nullable |                 Default                 
------------+-----------------------------+----------+-----------------------------------------
 id         | bigint                      | not null | nextval('favorite_files_id_seq'::regclass)
 user_id    | bigint                      | not null | 
 project_id | bigint                      | not null | 
 filename   | character varying(255)      | not null | 
 added_at   | timestamp without time zone | not null | now()

Indexes:
    "favorite_files_pkey" PRIMARY KEY, btree (id)
    "uq_user_project_filename" UNIQUE CONSTRAINT, btree (user_id, project_id, filename)
    "idx_favorite_files_user_id" btree (user_id)
    "idx_favorite_files_project_filename" btree (project_id, filename)

Foreign-key constraints:
    "favorite_files_project_id_fkey" FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    "favorite_files_user_id_fkey" FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

## üéØ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å "–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã":**

### **–ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤** - `/api/projects/attachments`
- ‚úÖ **–ú–æ–∏ —Ñ–∞–π–ª—ã** - `/api/projects/attachments?only_my=true`
- ‚úÖ **–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã** - `/api/projects/favorites/attachments`
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ** - `POST /api/projects/{project_id}/attachments/{filename}/favorite`
- ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ** - `DELETE /api/projects/{project_id}/attachments/{filename}/favorite`

### **–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–§–∞–π–ª—ã" —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:**
1. **"–í—Å–µ —Ñ–∞–π–ª—ã"** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤
2. **"–ú–æ–∏ —Ñ–∞–π–ª—ã"** - —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
3. **"–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"** - —Ñ–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚≠ê

## üöÄ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:**

### **–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É (`rvevau` / `rvevau`)
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É **"–§–∞–π–ª—ã"**
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫:
   - ‚úÖ "–í—Å–µ —Ñ–∞–π–ª—ã"
   - ‚úÖ "–ú–æ–∏ —Ñ–∞–π–ª—ã"  
   - ‚úÖ "–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"

### **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost/api/projects/attachments
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost/api/projects/attachments?only_my=true
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost/api/projects/favorites/attachments
```

## üéâ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

**‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê!**

- **–¢–∞–±–ª–∏—Ü–∞ `favorite_files` —Å–æ–∑–¥–∞–Ω–∞** –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **API endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 401 –≤–º–µ—Å—Ç–æ 422** - –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å "–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã" –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞**
- **–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–§–∞–π–ª—ã" —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫**

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã, –≤–∫–ª—é—á–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!** üåü
